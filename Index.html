<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WorkPulse V91 (Sanitizer Edition)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Inter', sans-serif; 
            min-height: 100vh;
            transition: background 0.5s ease, color 0.3s ease;
            overflow-x: hidden;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 4px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }

        /* Dark Mode Inputs Fix */
        .dark-date-icon::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; opacity: 0.6; }
        .dark-date-icon::-webkit-calendar-picker-indicator:hover { opacity: 1; }
        input[type="date"] { cursor: pointer; }

        /* --- THEMES --- */
        .theme-light-bg { background-color: #f8fafc; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 24px 24px; background-attachment: fixed; }
        .glass-card-light { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .glass-header-light { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(226, 232, 240, 1); }

        .theme-dark-bg { background-color: #0f172a; background-image: radial-gradient(rgba(51, 65, 85, 0.3) 1px, transparent 1px); background-size: 24px 24px; background-attachment: fixed; }
        .glass-card-dark { background: linear-gradient(180deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 6px rgba(0,0,0,0.2); color: white; }
        .glass-card-dark:hover { border-color: rgba(99, 102, 241, 0.4); background: linear-gradient(180deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%); transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3); }
        .glass-header-dark { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }

        .card-stuck-dark { background: rgba(127, 29, 29, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); color: white; }
        .card-stuck-light { background: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1); }

        .rotate-icon { transition: transform 0.2s ease; }
        .rotate-180 { transform: rotate(180deg); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .expand-content { animation: slideDown 0.2s ease-out; }
        @keyframes confetti { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(var(--x), var(--y)) scale(0); opacity: 0; } } 
        .animate-confetti { animation: confetti 0.8s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <div style="position:fixed; bottom:10px; right:10px; z-index:9999; opacity:0.8;">
        <button onclick="localStorage.clear();window.location.reload()" style="background:red; color:white; padding:4px 8px; border-radius:4px; font-size:10px; border:1px solid white;">Hard Reset</button>
    </div>

    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyAy21JRwYZgOOEXZ5tHzi9cteMe6VhmwA8",
            authDomain: "workpulse-b82a4.firebaseapp.com",
            projectId: "workpulse-b82a4",
            storageBucket: "workpulse-b82a4.firebasestorage.app",
            messagingSenderId: "596333846028",
            appId: "1:596333846028:web:a2dfbcab4539427b831829"
        };
        if (!firebase.apps.length) { 
            firebase.initializeApp(firebaseConfig);
            // V91: PERSISTENCE DISABLED FOR SAFETY
        }
        const db = firebase.firestore();

        const STATUS_CONFIG = { 
            'To Do': { light: 'bg-slate-100 text-slate-700', dark: 'bg-slate-700/50 text-slate-300 border-slate-600', next: 'In Progress' }, 
            'In Progress': { light: 'bg-orange-50 text-orange-700 border-orange-200', dark: 'bg-orange-900/30 text-orange-200 border-orange-700/50', next: 'Pending Review' }, 
            'Pending Review': { light: 'bg-purple-50 text-purple-700 border-purple-200', dark: 'bg-purple-900/30 text-purple-200 border-purple-700/50', next: 'Done' }, 
            'Done': { light: 'bg-green-50 text-green-700 border-green-200', dark: 'bg-green-900/30 text-green-200 border-green-700/50', next: 'Archive' }
        };
        
        const PRIORITIES = {
            'Urgent': { light: 'text-red-700 bg-red-50 border-red-200', dark: 'text-red-200 bg-red-900/40 border-red-700', score: 4 },
            'High': { light: 'text-orange-700 bg-orange-50 border-orange-200', dark: 'text-orange-200 bg-orange-900/40 border-orange-700', score: 3 },
            'Medium': { light: 'text-blue-700 bg-blue-50 border-blue-200', dark: 'text-blue-200 bg-blue-900/40 border-blue-700', score: 2 },
            'Low': { light: 'text-slate-600 bg-slate-100 border-slate-200', dark: 'text-slate-400 bg-slate-800/50 border-slate-700', score: 1 }
        };

        const DEPARTMENTS = ['FOH', 'BOH'];
        const ROLES = ['Area Manager', 'Store Leader', 'Manager']; 

        const safeParse = (key, fallback) => { try { const item = localStorage.getItem(key); return item ? JSON.parse(item) : fallback; } catch (e) { return fallback; } };
        const norm = (str) => (str || '').toLowerCase().trim();
        const formatDate = (ts) => { if (!ts) return '-'; try { return (ts.toDate ? ts.toDate() : new Date(ts)).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' }); } catch (e) { return '-'; } };
        const getSafeAssignees = (t) => { if (!t) return ['Unassigned']; if (Array.isArray(t.assignees)) return t.assignees; if (t.assigneeName) return [t.assigneeName]; return ['Unassigned']; };
        const formatCalDate = (d) => d ? d.replace(/-/g, '') : '';
        const getNextDay = (dateStr) => { if(!dateStr) return ''; const date = new Date(dateStr); date.setDate(date.getDate() + 1); return date.toISOString().split('T')[0].replace(/-/g, ''); };
        const compressImage = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { try { const canvas = document.createElement('canvas'); const scale = 800 / img.width; canvas.width = 800; canvas.height = img.height * scale; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7)); } catch (err) { reject(err); } }; img.onerror = reject; }; reader.onerror = reject; });
        const getUrgency = (dueDateStr, status) => { 
            if (!dueDateStr || status === 'Done') return { color: 'text-slate-400', icon: null }; 
            try { const today = new Date(); today.setHours(0,0,0,0); const due = new Date(dueDateStr + 'T00:00:00'); const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24)); if (diffDays < 0) return { color: 'text-red-500 font-bold', icon: 'AlertCircle' }; if (diffDays <= 3) return { color: 'text-amber-500 font-bold', icon: 'Clock' }; } catch(e) {}
            return { color: 'text-slate-400', icon: null }; 
        };

        const Icon = ({ name, size = 20, className = "" }) => { 
            if (!window.lucide || !window.lucide.icons) return null; 
            const iconData = window.lucide.icons[name.charAt(0).toUpperCase() + name.slice(1)]; 
            if (!iconData) return <span style={{width:size, height:size, display:'inline-block'}} />; 
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{iconData.map(([tag, attrs], i) => { const ReactTag = tag; const reactAttrs = Object.keys(attrs).reduce((acc, key) => { acc[key.replace(/-([a-z])/g, (g) => g[1].toUpperCase())] = attrs[key]; return acc; }, {}); return <ReactTag key={i} {...reactAttrs} />; })}</svg>; 
        };

        const StatusPill = ({ status, onClick, isDarkMode }) => {
            const config = STATUS_CONFIG[status] || { light: 'bg-slate-100', dark: 'bg-slate-800' }; 
            return <button onClick={onClick} className={`${isDarkMode ? config.dark : config.light} text-[10px] font-bold uppercase px-4 py-1.5 rounded-full border w-32 text-center transition-all active:scale-95 hover:opacity-90 tracking-wider shadow-sm border-transparent`}>{status || 'Unknown'}</button>;
        };

        const ProgressBattery = ({ tasks, isDarkMode }) => { 
            const total = tasks?.length || 0; if (total === 0) return null; 
            const getBatColor = (t) => {
                if(t.stuckReason) return 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]';
                const s = t.status;
                if(s==='Done') return 'bg-emerald-500/80';
                if(s==='To Do') return isDarkMode ? 'bg-slate-700' : 'bg-slate-300';
                if(s==='In Progress') return 'bg-orange-500/80';
                return 'bg-purple-500/80';
            }
            return <div className={`flex h-1.5 w-full rounded-full overflow-hidden mb-6 ${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-slate-200/50'}`}>{tasks.map(t => <div key={t.id} style={{ width: `${(1/total)*100}%` }} className={`transition-all duration-500 ${getBatColor(t)}`} />)}</div>; 
        };
        
        const EmptyState = ({ message }) => <div className="flex flex-col items-center justify-center py-12 text-slate-400/50"><Icon name="Ghost" size={40} className="mb-3 opacity-30" /><span className="text-sm font-medium opacity-60">{message}</span></div>;
        const Confetti = () => <div className="fixed inset-0 pointer-events-none z-[100] overflow-hidden">{Array.from({length: 60}).map((_, i) => <div key={i} className="absolute w-2 h-2 rounded-full animate-confetti" style={{ left: '50%', top: '50%', backgroundColor: ['#F87171', '#34D399', '#60A5FA', '#FBBF24', '#A78BFA'][i % 5], '--x': (Math.random() * 600 - 300) + 'px', '--y': (Math.random() * 600 - 300) + 'px' }}></div>)}</div>;

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() { if (this.state.hasError) return <div className="p-10 text-center"><h1>Recovering...</h1><button onClick={()=>window.location.reload()} className="mt-4 bg-indigo-600 text-white px-6 py-2 rounded-full">Reload</button></div>; return this.props.children; }
        }

        function App() {
            const KEY_USER = 'wp_v48_user'; const KEY_TEAM = 'wp_v48_team'; const KEY_COLLAPSED = 'wp_v48_collapsed'; const KEY_THEME = 'wp_theme_mode';
            const [tasks, setTasks] = React.useState([]); // V91: Unified Raw List
            
            const [profile, setProfile] = React.useState(null); const [team, setTeam] = React.useState([]); const [loading, setLoading] = React.useState(true); const [viewMode, setViewMode] = React.useState('kanban'); const [pageMode, setPageMode] = React.useState('my-work'); const [filterQuery, setFilterQuery] = React.useState(''); const [modal, setModal] = React.useState(null); const [selectedTask, setSelectedTask] = React.useState(null); const [showConfetti, setShowConfetti] = React.useState(false); const [flash, setFlash] = React.useState(false); const [isDarkMode, setIsDarkMode] = React.useState(false);
            const [isEditingTitle, setIsEditingTitle] = React.useState(false); const [isEditingDesc, setIsEditingDesc] = React.useState(false); const [isManagingAssignees, setIsManagingAssignees] = React.useState(false); const [editTitleValue, setEditTitleValue] = React.useState(''); const [editDescValue, setEditDescValue] = React.useState(''); 
            const [viewImage, setViewImage] = React.useState(null); const [collapsedSections, setCollapsedSections] = React.useState({ FOH: false, BOH: false }); const [expandedTasks, setExpandedTasks] = React.useState({}); 
            const [tempName, setTempName] = React.useState(''); const [tempEmail, setTempEmail] = React.useState(''); const [tempRole, setTempRole] = React.useState('Manager'); const [newTaskTitle, setNewTaskTitle] = React.useState(''); const [newTaskDesc, setNewTaskDesc] = React.useState(''); const [newTaskDept, setNewTaskDept] = React.useState('FOH'); const [newTaskDueDate, setNewTaskDueDate] = React.useState(''); const [newTaskPhoto, setNewTaskPhoto] = React.useState(null); const [newTaskAssignees, setNewTaskAssignees] = React.useState([]); const [newTaskRequireReview, setNewTaskRequireReview] = React.useState(true); const [newTaskPriority, setNewTaskPriority] = React.useState('Medium'); const [chatInput, setChatInput] = React.useState(''); const [subtaskInput, setSubtaskInput] = React.useState(''); const [memberFormName, setMemberFormName] = React.useState(''); const [memberFormEmail, setMemberFormEmail] = React.useState(''); const [memberFormRole, setMemberFormRole] = React.useState('Manager'); const [editingMemberId, setEditingMemberId] = React.useState(null);
            const [dateFilter, setDateFilter] = React.useState({ start: '', end: '' });

            // V91: SANITIZER
            const sanitizeTask = (data) => ({
                ...data,
                status: STATUS_CONFIG[data.status] ? data.status : 'To Do',
                priority: PRIORITIES[data.priority] ? data.priority : 'Medium',
                assignees: Array.isArray(data.assignees) ? data.assignees : ['Unassigned'],
                subtasks: Array.isArray(data.subtasks) ? data.subtasks : [],
                comments: Array.isArray(data.comments) ? data.comments : [],
                description: data.description || '',
                archived: !!data.archived,
                createdAt: data.createdAt || new Date().toISOString(),
                stuckReason: data.stuckReason || ''
            });

            React.useEffect(() => {
                const currentUser = safeParse(KEY_USER, null); if (currentUser) setProfile(currentUser); else setModal('join'); setTeam(safeParse(KEY_TEAM, [])); setCollapsedSections(safeParse(KEY_COLLAPSED, { FOH: false, BOH: false })); setIsDarkMode(safeParse(KEY_THEME, false));
                
                // V91: RAW FETCH (NO FILTERS, NO SORTING ON SERVER)
                const unsubscribe = db.collection('tasks').onSnapshot(snapshot => {
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...sanitizeTask(doc.data()) }));
                    setTasks(loaded);
                    setLoading(false);
                }, err => {
                    console.error("Fatal DB Error:", err);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            const toggleTheme = () => { const newMode = !isDarkMode; setIsDarkMode(newMode); localStorage.setItem(KEY_THEME, JSON.stringify(newMode)); };
            const toggleSection = (dept) => { const newState = { ...collapsedSections, [dept]: !collapsedSections[dept] }; setCollapsedSections(newState); localStorage.setItem(KEY_COLLAPSED, JSON.stringify(newState)); };
            const toggleTaskExpand = (e, taskId) => { e.stopPropagation(); setExpandedTasks(prev => ({ ...prev, [taskId]: !prev[taskId] })); };
            const getMemberRole = (name) => { const m = team.find(tm => norm(tm.name) === norm(name)); return m ? m.role : 'Staff'; };
            const getRolePill = (role) => {
                if(role === 'Area Manager') return isDarkMode ? 'bg-amber-900/20 text-amber-200 border-amber-800/30' : 'bg-amber-50 text-amber-800 border-amber-200';
                if(role === 'Store Leader') return isDarkMode ? 'bg-blue-900/20 text-blue-200 border-blue-800/30' : 'bg-blue-50 text-blue-800 border-blue-200';
                if(role === 'Manager') return isDarkMode ? 'bg-indigo-900/20 text-indigo-200 border-indigo-800/30' : 'bg-indigo-50 text-indigo-800 border-indigo-200';
                return isDarkMode ? 'bg-slate-800/50 text-slate-400 border-slate-700/30' : 'bg-slate-100 text-slate-600 border-slate-200';
            };
            const getAssigneeEmails = (t) => { const safeList = getSafeAssignees(t); return safeList.map(name => { const member = team.find(m => norm(m.name) === norm(name)); return member ? member.email : null; }).filter(e => e).join(','); };
            const handleToggleStuck = () => { if (selectedTask.stuckReason) { updateTask(selectedTask.id, { stuckReason: null }); } else { const reason = prompt("Why is this task stuck? (e.g. Waiting on Vendor)"); if (reason) { updateTask(selectedTask.id, { stuckReason: reason }); } } };
            const handleJoin=()=>{if(!tempName)return alert("Required");const u={id:Date.now().toString(),name:tempName.trim(),email:tempEmail,role:tempRole};setProfile(u);localStorage.setItem(KEY_USER,JSON.stringify(u));setModal(null);const exists=team.find(m=>norm(m.name)===norm(u.name));if(!exists){const newTeam=[...team,u];setTeam(newTeam);localStorage.setItem(KEY_TEAM,JSON.stringify(newTeam));}};
            const handleCreateTask=()=>{if(!newTaskTitle)return;const finalAssignees=newTaskAssignees.length>0?newTaskAssignees:['Unassigned'];let autoSubtasks=[];if(newTaskAssignees.includes('Everyone')&&team.length>0)autoSubtasks=team.map(m=>({id:Date.now()+Math.random().toString(),text:m.name,completed:false}));const t={id:Date.now().toString(),title:newTaskTitle,description:newTaskDesc,status:'To Do',department:newTaskDept,priority:newTaskPriority,assignees:finalAssignees,creatorName:profile.name,creatorRole:profile.role,dueDate:newTaskDueDate,photo:newTaskPhoto,comments:[],subtasks:autoSubtasks,archived:false,requireReview:newTaskRequireReview,createdAt:new Date().toISOString(), stuckReason: ''};db.collection('tasks').doc(t.id).set(t).then(()=>{setModal(null);setNewTaskTitle('');setNewTaskDesc('');setNewTaskPhoto(null);setNewTaskAssignees([]);setNewTaskRequireReview(true);}).catch(err=>alert("Error saving: "+err.message));};
            const cycleStatus=(task,e)=>{if(e&&e.stopPropagation)e.stopPropagation();const safeAssignees=getSafeAssignees(task);const myName=norm(profile.name);const canEdit=safeAssignees.some(a=>norm(a)===myName)||safeAssignees.includes('Everyone')||['Area Manager','Store Leader','Manager'].includes(profile.role)||norm(task.creatorName)===myName;if(!canEdit)return alert(`Access Denied.`);const needsReview=task.requireReview!==false;if(task.status==='Pending Review'&&!['Area Manager','Store Leader','Manager'].includes(profile.role))return alert("Manager approval needed.");let next=STATUS_CONFIG[task.status].next;if(task.status==='In Progress'&&!needsReview)next='Done';if(next==='Archive'){updateTask(task.id,{archived:true});setShowConfetti(true);setTimeout(()=>setShowConfetti(false),2000);return;}updateTask(task.id,{status:next});};
            const restoreTask=(task)=>updateTask(task.id,{archived:false,status:'In Progress'});
            const updateTask=(id,data)=>{
                const updated=tasks.map(t=>t.id===id?{...t,...data}:t); setTasks(updated);
                if(selectedTask&&selectedTask.id===id)setSelectedTask({...selectedTask,...data});
                db.collection('tasks').doc(id).update(data).catch(e=>console.error("Update failed",e));
            };
            const deleteTask=()=>{const isCreator=norm(selectedTask.creatorName||'')===norm(profile.name);const isAdmin=profile.role==='Area Manager';if(!isCreator&&!isAdmin)return alert("Only the assigner can delete this task.");if(confirm("Delete task?")){db.collection('tasks').doc(selectedTask.id).delete();setModal(null);}};
            const handleSubtaskToggle=(subtask)=>{const isEveryoneTask=selectedTask.assignees.includes('Everyone');const isMyName=norm(subtask.text)===norm(profile.name);const isAdmin=['Area Manager','Store Leader'].includes(profile.role);if(isEveryoneTask&&!isMyName&&!isAdmin)return;const newSubtasks=(selectedTask.subtasks||[]).map(s=>s.id===subtask.id?{...s,completed:!s.completed}:s);const allComplete=newSubtasks.every(s=>s.completed);let updates={subtasks:newSubtasks};if(isEveryoneTask&&allComplete&&selectedTask.status!=='Done'&&selectedTask.status!=='Pending Review'){updates.status=selectedTask.requireReview?'Pending Review':'Done';setShowConfetti(true);setTimeout(()=>setShowConfetti(false),2000);}updateTask(selectedTask.id,updates);};
            const handlePhotoUpload=async(e)=>{const file=e.target.files[0];if(file){try{const b64=await compressImage(file);setNewTaskPhoto(b64);setFlash(true);setTimeout(()=>setFlash(false),500);}catch(err){console.error(err);}}};
            const handleAddAssignee=(name)=>{if(!selectedTask)return;let current=[...selectedTask.assignees];if(current.includes(name))current=current.filter(n=>n!==name);else{if(current.includes('Unassigned'))current=current.filter(n=>n!=='Unassigned');current.push(name);}updateTask(selectedTask.id,{assignees:current});};
            const handleSaveMember=()=>{if(!memberFormName)return;const memberData={name:memberFormName,email:memberFormEmail,role:memberFormRole||'Manager'};if(editingMemberId){const updatedTeam=team.map(m=>m.id===editingMemberId?{...m,...memberData}:m);setTeam(updatedTeam);localStorage.setItem(KEY_TEAM,JSON.stringify(updatedTeam));setEditingMemberId(null);}else{const newId=Date.now().toString();const newTeam=[...team,{...memberData,id:newId}];setTeam(newTeam);localStorage.setItem(KEY_TEAM,JSON.stringify(newTeam));}setMemberFormName('');setMemberFormEmail('');setMemberFormRole('Manager');};
            const handleEditMember=(m)=>{setMemberFormName(m.name);setMemberFormEmail(m.email);setMemberFormRole(m.role);setEditingMemberId(m.id);};
            const handleCancelEdit=()=>{setMemberFormName('');setMemberFormEmail('');setMemberFormRole('Manager');setEditingMemberId(null);};
            const handleDeleteMember=(id)=>{if(!confirm("Remove?"))return;const newTeam=team.filter(m=>m.id!==id);setTeam(newTeam);localStorage.setItem(KEY_TEAM,JSON.stringify(newTeam));if(editingMemberId===id)handleCancelEdit();};
            const downloadBackup=()=>{const backup={date:new Date().toISOString(),user:profile,team:team,tasks:tasks};const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(backup));const a=document.createElement('a');a.href=dataStr;a.download="workpulse_backup.json";document.body.appendChild(a);a.click();a.remove();};
            const handleResetApp=()=>{if(confirm("Reset local data?")){localStorage.clear();window.location.reload();}};

            // --- CLIENT SIDE LOGIC ---
            // 1. Sort by Date (Client)
            let allSorted = [...tasks].sort((a,b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
            
            // 2. Split Active/History
            let displayTasks = viewMode === 'history' ? allSorted.filter(t => t.archived) : allSorted.filter(t => !t.archived);

            // 3. Filter (Date) - Client Side
            if (viewMode === 'history' && dateFilter.start && dateFilter.end) {
                const s = new Date(dateFilter.start).getTime();
                const e = new Date(dateFilter.end).getTime() + 86400000;
                displayTasks = displayTasks.filter(t => {
                     const tDate = new Date(t.createdAt).getTime();
                     return tDate >= s && tDate <= e;
                });
            }

            // 4. Filter (User/Search)
            if (viewMode !== 'history' && viewMode !== 'kanban' && pageMode === 'my-work' && profile) { const myName = norm(profile.name); displayTasks = displayTasks.filter(t => { const safe = getSafeAssignees(t); return safe.some(a => norm(a) === myName) || safe.includes('Everyone'); }); }
            if (filterQuery) { const q = norm(filterQuery); displayTasks = displayTasks.filter(t => norm(t.title).includes(q) || getSafeAssignees(t).some(a => norm(a).includes(q))); }
            if (viewMode === 'list' || pageMode === 'my-work') { displayTasks.sort((a,b) => { const scoreA = PRIORITIES[a.priority]?.score || 2; const scoreB = PRIORITIES[b.priority]?.score || 2; return scoreB - scoreA; }); }
            
            const fohTasks = displayTasks.filter(t => t.department === 'FOH');
            const bohTasks = displayTasks.filter(t => t.department === 'BOH');

            const mainBg = isDarkMode ? 'theme-dark-bg' : 'theme-light-bg';
            const cardBg = isDarkMode ? 'glass-card-dark' : 'glass-card-light';
            const headerBg = isDarkMode ? 'glass-header-dark' : 'glass-header-light';
            const textPrimary = isDarkMode ? 'text-slate-200' : 'text-slate-900'; 
            const textSecondary = isDarkMode ? 'text-slate-400' : 'text-slate-500';

            const myPendingTasks = tasks.filter(t => !t.archived).filter(t => { const safe = getSafeAssignees(t); return (safe.includes(profile?.name) || safe.includes('Everyone')) && t.status !== 'Done'; }).length;
            const overdueTasks = tasks.filter(t => !t.archived).filter(t => t.dueDate && t.status !== 'Done' && t.dueDate < new Date().toISOString().split('T')[0]).length;
            const stuckTasks = tasks.filter(t => !t.archived).filter(t => !!t.stuckReason).length;

            if (loading) return <div className={`h-screen flex items-center justify-center font-bold animate-pulse ${isDarkMode ? 'bg-slate-900 text-indigo-400' : 'bg-white text-indigo-600'}`}>Connecting...</div>;

            const StatCard = ({ label, count, icon, color }) => (
                <div className={`flex-1 p-4 rounded-2xl border flex items-center justify-between ${isDarkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/60 border-white shadow-sm'}`}>
                    <div><p className={`text-xs font-bold uppercase ${textSecondary}`}>{label}</p><p className={`text-2xl font-bold ${textPrimary}`}>{count}</p></div>
                    <div className={`p-2 rounded-xl ${color} bg-opacity-20 text-opacity-100`}><Icon name={icon} size={20} /></div>
                </div>
            );

            const TaskRow = ({ task }) => {
                const safeAssignees = getSafeAssignees(task);
                const urgency = getUrgency(task.dueDate, task.status);
                const config = STATUS_CONFIG[task.status] || { light: 'bg-slate-100', dark: 'bg-slate-800' };
                const isExpanded = expandedTasks[task.id];
                const p = PRIORITIES[task.priority] || PRIORITIES['Medium'];
                const needsReview = task.requireReview !== false;
                const totalSub = (task.subtasks || []).length; const doneSub = (task.subtasks || []).filter(s => s.completed).length;
                const isStuck = !!task.stuckReason;
                const cardStyle = isStuck ? (isDarkMode ? 'card-stuck-dark' : 'card-stuck-light') : cardBg;

                return (
                    <div className={`${cardStyle} mb-3 rounded-2xl transition-all shadow-sm`}>
                        <div onClick={() => { setSelectedTask(task); setModal('detail'); }} className={`grid grid-cols-12 gap-4 p-5 items-center cursor-pointer ${task.status === 'Done' ? 'opacity-60' : ''}`}>
                            <div className="col-span-12 md:col-span-5 flex items-start gap-4">
                                <div className="min-w-0 flex-1">
                                    {isStuck && <div className="flex items-center gap-2 text-red-500 font-bold text-xs mb-2 uppercase tracking-wider"><Icon name="AlertTriangle" size={12} /> {task.stuckReason}</div>}
                                    <span className={`text-lg font-bold block leading-tight break-words whitespace-pre-wrap ${isStuck ? (isDarkMode?'text-white':'text-red-900') : textPrimary} ${task.status === 'Done' ? 'line-through decoration-2 decoration-slate-400' : ''}`}>{task.title}</span>
                                    <div className="flex flex-wrap items-center gap-3 mt-2.5">
                                        <span className={`text-xs font-medium flex items-center gap-1 ${isStuck ? 'text-red-400' : textSecondary}`}><Icon name="User" size={12}/> {task.creatorName ? task.creatorName.split(' ')[0] : '...'}</span>
                                        {task.description && <Icon name="AlignLeft" size={14} className={isDarkMode ? "text-indigo-300/70" : "text-indigo-400"}/>}
                                        {task.photo && <Icon name="Camera" size={14} className={isDarkMode ? "text-indigo-300/70" : "text-indigo-500"}/>}
                                        {totalSub > 0 && <span className={`flex items-center gap-1 text-[10px] px-2 py-0.5 rounded-full border font-bold ${doneSub === totalSub ? (isDarkMode?'bg-green-900/40 text-green-300 border-green-800':'bg-green-50 text-green-700 border-green-200') : (isDarkMode?'bg-orange-900/40 text-orange-300 border-orange-800':'bg-orange-50 text-orange-700 border-orange-200')}`}><Icon name="ListTodo" size={10} /> {doneSub}/{totalSub}</span>}
                                        {task.comments?.length > 0 && <span className={`flex items-center gap-1 text-[10px] px-2 py-0.5 rounded-full ${isDarkMode?'bg-slate-700/50 text-slate-300':'bg-slate-100 text-slate-500'}`}><Icon name="MessageCircle" size={10} /> {task.comments.length}</span>}
                                        {!needsReview && task.status !== 'Done' && <span className={`text-[10px] border px-2 py-0.5 rounded-full font-medium ${isDarkMode?'border-slate-600/50 text-slate-400':'border-slate-200 text-slate-500 bg-white'}`}>Fast Track</span>}
                                    </div>
                                </div>
                            </div>
                            <div className="hidden md:flex col-span-2 items-center"><span className={`text-[10px] font-bold px-3 py-1 rounded-full border ${isDarkMode ? p.dark : p.light}`}>{task.priority || 'Medium'}</span></div>
                            <div className="hidden md:flex col-span-3 gap-1.5 flex-wrap">{safeAssignees.map((a,i) => <span key={i} className={`text-[10px] px-2.5 py-1 rounded-full font-bold border truncate max-w-[120px] ${getRolePill(getMemberRole(a))}`}>{a}</span>)}</div>
                            <div className="col-span-6 md:col-span-2 flex justify-end md:justify-center"><StatusPill status={task.status} onClick={(e)=>cycleStatus(task,e)} isDarkMode={isDarkMode} /></div>
                        </div>
                        {isExpanded && (
                            <div className={`px-12 pb-6 border-t ${isDarkMode ? 'bg-slate-900/40 border-slate-700/50' : 'bg-white/40 border-white/50'} expand-content rounded-b-2xl backdrop-blur-sm`}>
                                {task.description && <div className={`mt-3 text-sm ${textSecondary} whitespace-pre-wrap p-2 leading-relaxed`}>{task.description}</div>}
                                {task.subtasks && task.subtasks.length > 0 && <div className="mt-4 space-y-2"><h4 className={`text-[10px] font-bold uppercase ${textSecondary} mb-2 tracking-wider`}>Subtasks</h4>{task.subtasks.map(s => <div key={s.id} className={`flex items-center gap-3 text-sm ${textPrimary}`}><div className={`w-4 h-4 rounded-full border flex items-center justify-center ${s.completed ? 'bg-green-500 border-green-500' : (isDarkMode?'border-slate-600 bg-slate-700':'bg-white border-slate-300')}`}>{s.completed && <Icon name="Check" size={10} className="text-white"/>}</div><span className={s.completed ? 'line-through opacity-50' : ''}>{s.text}</span></div>)}</div>}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className={`min-h-screen pb-10 transition-colors duration-300 ${mainBg}`}>
                    {showConfetti && <Confetti />} {flash && <div className="animate-flash"></div>}
                    {viewImage && <div className="fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in duration-200" onClick={() => setViewImage(null)}><button onClick={() => setViewImage(null)} className="absolute top-4 right-4 p-3 bg-white/10 text-white rounded-full hover:bg-white/20 transition-colors"><Icon name="X" size={24} /></button><img src={viewImage} className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" onClick={(e) => e.stopPropagation()} /></div>}

                    <header className={`${headerBg} sticky top-0 z-20 px-4 h-16 flex items-center justify-between transition-all`}>
                        <div className="flex items-center gap-3"><div className="bg-gradient-to-tr from-indigo-600 to-purple-600 p-2 rounded-xl text-white shadow-lg shadow-indigo-500/30"><Icon name="Layout" size={20} /></div><h1 className={`text-xl font-bold tracking-tight ${textPrimary}`}>WorkPulse <span className={`text-[10px] px-2 py-0.5 rounded-full ml-1 align-top border ${isDarkMode ? 'bg-indigo-900/30 border-indigo-500/30 text-indigo-300' : 'bg-white/50 border-indigo-100 text-indigo-700'}`}>V91</span></h1></div>
                        <div className="flex gap-3 items-center">
                             <button onClick={toggleTheme} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'bg-slate-800 text-amber-300 hover:bg-slate-700' : 'bg-amber-100 text-amber-600 hover:bg-amber-200'}`}><Icon name={isDarkMode ? "Moon" : "Sun"} size={18}/></button>
                             {profile && <div className={`flex p-1 rounded-full border shadow-sm ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white/50 border-white/60'}`}><button onClick={() => setViewMode('list')} className={`p-2 rounded-full transition-all ${viewMode === 'list' ? (isDarkMode?'bg-slate-700 text-white shadow':'bg-white shadow text-indigo-600') : 'text-slate-400 hover:text-slate-500'}`}><Icon name="List" size={18}/></button><button onClick={() => setViewMode('kanban')} className={`p-2 rounded-full transition-all ${viewMode === 'kanban' ? (isDarkMode?'bg-slate-700 text-white shadow':'bg-white shadow text-indigo-600') : 'text-slate-400 hover:text-slate-500'}`}><Icon name="Kanban" size={18}/></button><button onClick={() => setViewMode('history')} className={`p-2 rounded-full transition-all ${viewMode === 'history' ? (isDarkMode?'bg-slate-700 text-white shadow':'bg-white shadow text-indigo-600') : 'text-slate-400 hover:text-slate-500'}`}><Icon name="History" size={18}/></button></div>}
                            {profile ? <div className="flex gap-2"><button onClick={() => setModal('settings')} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-white/50 text-slate-500'}`}><Icon name="Settings" size={20} /></button><button onClick={() => setModal('task')} className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-2 rounded-full flex items-center gap-1.5 text-sm font-bold shadow-lg shadow-indigo-500/20 hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 transition-all"><Icon name="Plus" size={18} /> New</button></div> : <button onClick={() => setModal('join')} className="text-indigo-600 font-bold text-sm">Log In</button>}
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {profile ? (
                            <ErrorBoundary>
                            <>
                                {viewMode !== 'history' && (
                                    <div className="mb-8 space-y-6">
                                        <div className="grid grid-cols-3 gap-4">
                                            <StatCard label="My Tasks" count={myPendingTasks} icon="CheckSquare" color="bg-indigo-500 text-indigo-600" />
                                            <StatCard label="Overdue" count={overdueTasks} icon="Clock" color="bg-red-500 text-red-600" />
                                            <StatCard label="Stuck" count={stuckTasks} icon="AlertTriangle" color="bg-orange-500 text-orange-600" />
                                        </div>
                                        <div className="relative flex gap-4 items-center">
                                            <div className="relative flex-1 group"><div className="absolute left-4 top-3.5 text-slate-400 group-focus-within:text-indigo-500 transition-colors"><Icon name="Search" size={18} /></div><input type="text" placeholder="Search tasks..." value={filterQuery} onChange={e => setFilterQuery(e.target.value)} className={`w-full pl-12 pr-4 py-3.5 rounded-full text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm border ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white placeholder-slate-500' : 'bg-white/80 backdrop-blur border-white focus:border-indigo-200'}`} /></div>
                                            {viewMode !== 'kanban' && <div className={`flex p-1 rounded-full border ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white/50 border-white/60'}`}><button onClick={() => setPageMode('my-work')} className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${pageMode === 'my-work' ? (isDarkMode?'bg-slate-700 text-white shadow':'bg-white text-indigo-600 shadow-sm') : 'text-slate-400 hover:text-slate-500'}`}>My Work</button><button onClick={() => setPageMode('team-tasks')} className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${pageMode === 'team-tasks' ? (isDarkMode?'bg-slate-700 text-white shadow':'bg-white text-indigo-600 shadow-sm') : 'text-slate-400 hover:text-slate-500'}`}>Team</button></div>}
                                        </div>
                                    </div>
                                )}

                                {viewMode === 'history' && (
                                    <div className="mb-8 space-y-4">
                                        <div className={`p-4 rounded-2xl border flex flex-wrap items-end gap-4 ${isDarkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/60 border-white shadow-sm'}`}>
                                            <div className="flex-1 min-w-[200px]"><label className={`text-xs font-bold uppercase mb-1 block ${textSecondary}`}>Search Text</label><div className="relative group"><div className="absolute left-3 top-3 text-slate-400"><Icon name="Search" size={16} /></div><input type="text" placeholder="Task name, person..." value={filterQuery} onChange={e => setFilterQuery(e.target.value)} className={`w-full pl-10 pr-4 py-2.5 rounded-xl text-sm outline-none border ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200'}`} /></div></div>
                                            <div className="relative" onClick={(e) => e.currentTarget.querySelector('input').showPicker()}>
                                                <label className={`text-xs font-bold uppercase mb-1 block ${textSecondary}`}>Start Date</label>
                                                <input type="date" value={dateFilter.start} onChange={e => setDateFilter({...dateFilter, start: e.target.value})} className={`dark-date-icon px-3 py-2.5 rounded-xl text-sm border outline-none w-full cursor-pointer ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200'}`} />
                                            </div>
                                            <div className="relative" onClick={(e) => e.currentTarget.querySelector('input').showPicker()}>
                                                <label className={`text-xs font-bold uppercase mb-1 block ${textSecondary}`}>End Date</label>
                                                <input type="date" value={dateFilter.end} onChange={e => setDateFilter({...dateFilter, end: e.target.value})} className={`dark-date-icon px-3 py-2.5 rounded-xl text-sm border outline-none w-full cursor-pointer ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200'}`} />
                                            </div>
                                            <button onClick={() => { setDateFilter({start:'', end:''}); }} className="px-4 py-2.5 bg-slate-200 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-300 transition-colors flex items-center gap-2"><Icon name="RefreshCw" size={14}/> Clear Filter</button>
                                        </div>
                                        <div className={`text-xs text-center ${textSecondary}`}>Showing {displayTasks.length} archived tasks</div>
                                    </div>
                                )}
                                
                                {viewMode === 'list' && (
                                    <div className="space-y-8 animate-in slide-in-from-bottom-4 duration-500">
                                        {['FOH', 'BOH'].map(dept => {
                                            const deptTasks = displayTasks.filter(t => t.department === dept);
                                            const colors = dept === 'FOH' ? ['indigo', 'Coffee'] : ['orange', 'Utensils'];
                                            const isCollapsed = collapsedSections[dept];
                                            return (
                                                <div key={dept} className={`${cardBg} rounded-[2rem] overflow-hidden transition-all shadow-md`}>
                                                    <div onClick={() => toggleSection(dept)} className={`px-6 py-5 border-b ${isDarkMode?'border-slate-700 hover:bg-slate-700/50':'border-white/50 hover:bg-white/40'} flex items-center justify-between cursor-pointer transition-colors`}>
                                                        <div className="flex items-center gap-4"><div className={`p-2.5 rounded-xl shadow-sm ${isDarkMode ? 'bg-slate-700 text-white' : 'bg-white text-indigo-600'}`}><Icon name={colors[1]} size={22} /></div><h3 className={`font-bold text-xl ${textPrimary}`}>{dept}</h3><span className={`text-xs px-3 py-1 rounded-full font-bold border ${isDarkMode?'bg-slate-700 border-slate-600 text-slate-300':'bg-white border-slate-100 text-slate-500 shadow-sm'}`}>{deptTasks.length}</span></div>
                                                        <div className={`text-slate-400 transition-transform duration-300 ${isCollapsed ? '-rotate-90' : ''}`}><Icon name="ChevronDown" size={24} /></div>
                                                    </div>
                                                    {!isCollapsed && <div className="p-4 md:p-6">{deptTasks.length === 0 && <EmptyState message="No active tasks" />}{deptTasks.map(task => <TaskRow key={task.id} task={task} />)}</div>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                                {viewMode === 'history' && <div className={`${cardBg} rounded-[2rem] overflow-hidden animate-in fade-in duration-300 p-6 shadow-md`}>{displayTasks.length === 0 ? <EmptyState message="No history found" /> : displayTasks.map(task => <TaskRow key={task.id} task={task} />)}</div>}
                                {viewMode === 'kanban' && (
                                    <div className="space-y-8 animate-in fade-in duration-500">
                                        {['FOH', 'BOH'].map(dept => {
                                             const deptTasks = displayTasks.filter(t => t.department === dept);
                                             const color = dept === 'FOH' ? 'indigo' : 'orange';
                                             const isCollapsed = collapsedSections[dept];
                                             return (
                                                <div key={dept} className={`${isDarkMode?'bg-slate-900/30 border-slate-700':'bg-white/30 border-white/40'} rounded-[2.5rem] border overflow-hidden transition-all duration-300 backdrop-blur-sm`}>
                                                    <div className={`flex items-center justify-between p-6 cursor-pointer ${isDarkMode?'hover:bg-slate-800/50':'hover:bg-white/40'} transition-colors`} onClick={() => toggleSection(dept)}>
                                                        <div className="flex items-center gap-3"><h2 className={`text-2xl font-bold tracking-tight ${textPrimary}`}>{dept} Board</h2><span className={`text-xs font-bold px-3 py-1 rounded-full ${isDarkMode?'bg-slate-700 text-slate-300':'bg-white/80 text-slate-600'}`}>{deptTasks.length}</span></div>
                                                        <div className={`rotate-icon text-slate-400 ${isCollapsed ? 'rotate-180' : ''}`}><Icon name="ChevronDown" size={24}/></div>
                                                    </div>
                                                    {!isCollapsed && (
                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 px-6 pb-6 h-full">
                                                            {Object.keys(STATUS_CONFIG).map(status => {
                                                                const tasksInCol = deptTasks.filter(t => t.status === status);
                                                                return (
                                                                <div key={status} className={`flex flex-col rounded-3xl border h-[calc(100vh-280px)] shadow-lg backdrop-blur-md overflow-hidden ${isDarkMode?'bg-slate-900/30 border-slate-700':'bg-white/60 border-white/50'}`}>
                                                                    <div className={`sticky top-0 z-10 p-5 backdrop-blur-md border-b flex items-center justify-between ${isDarkMode?'bg-slate-800/90 border-slate-700':'bg-white/80 border-white'}`}><div className="flex items-center gap-3"><div className={`w-2.5 h-2.5 rounded-full ${STATUS_CONFIG[status][isDarkMode?'dark':'light'].split(' ')[0].replace('bg-','bg-opacity-100 bg-')}`}></div><h3 className={`font-bold text-sm ${textPrimary}`}>{status}</h3></div><span className={`text-[10px] font-bold px-2 py-0.5 rounded-full ${isDarkMode?'bg-slate-700 text-slate-300':'bg-slate-100 text-slate-500'}`}>{tasksInCol.length}</span></div>
                                                                    <div className="overflow-y-auto space-y-4 p-4 custom-scrollbar flex-1">
                                                                        {tasksInCol.length === 0 && <div className="h-full flex items-center justify-center opacity-20"><Icon name="ClipboardList" size={48} className={isDarkMode?'text-slate-600':'text-slate-400'}/> <span className="block mt-2 text-xs font-bold text-slate-500 uppercase">No tasks</span></div>}
                                                                        {tasksInCol.map(task => {
                                                                            const urgency = getUrgency(task.dueDate, task.status);
                                                                            const p = PRIORITIES[task.priority] || PRIORITIES['Medium'];
                                                                            const isTaskStuck = !!task.stuckReason;
                                                                            const cardClasses = isTaskStuck ? (isDarkMode ? 'card-stuck-dark' : 'card-stuck-light') : (isDarkMode?'glass-card-dark':'bg-white border-white hover:border-indigo-100');
                                                                            
                                                                            return (
                                                                            <div key={task.id} onClick={() => { setSelectedTask(task); setModal('detail'); }} className={`${cardClasses} p-5 rounded-2xl border cursor-pointer shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-200 group`}>
                                                                                 {isTaskStuck && <div className="flex items-center gap-1 text-red-500 font-bold text-[10px] mb-2 uppercase tracking-wider"><Icon name="AlertTriangle" size={12}/> {task.stuckReason}</div>}
                                                                                <div className="flex justify-between items-start mb-3"><span className={`text-[10px] font-bold px-2.5 py-1 rounded-full border ${isDarkMode ? p.dark : p.light}`}>{task.priority || 'Medium'}</span>{task.dueDate && <span className={`text-[10px] font-mono font-medium ${urgency.color}`}>{formatDate(task.dueDate+'T00:00:00')}</span>}</div>
                                                                                <p className={`text-sm font-bold mb-4 line-clamp-3 leading-relaxed ${textPrimary}`}>{task.title}</p>
                                                                                <div className={`flex items-center justify-between pt-3 border-t ${isDarkMode?'border-slate-700/50':'border-slate-50'}`}>
                                                                                    <div className="flex -space-x-1.5">{getSafeAssignees(task).map((a,i)=>(<div key={i} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center text-[9px] font-bold shadow-sm ${isDarkMode?'border-slate-700':'border-white'} ${getRolePill(getMemberRole(a))}`} title={a}>{a.charAt(0)}</div>))}</div>
                                                                                    <div className={`flex gap-3 transition-colors ${isDarkMode?'text-slate-500 group-hover:text-indigo-300':'text-slate-300 group-hover:text-indigo-400'}`}>
                                                                                        {task.description && <Icon name="AlignLeft" size={14} />}
                                                                                        {task.photo && <Icon name="Image" size={14} />}
                                                                                        {(task.comments?.length||0)>0 && <div className="flex items-center gap-0.5"><Icon name="MessageCircle" size={14}/><span className="text-[10px] font-bold">{task.comments.length}</span></div>}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        )})}
                                                                    </div>
                                                                </div>
                                                            )})}
                                                        </div>
                                                    )}
                                                </div>
                                             );
                                        })}
                                    </div>
                                )}
                            </>
                            </ErrorBoundary>
                        ) : (
                            <div className="min-h-screen flex items-center justify-center p-4">
                                <div className={`text-center py-24 backdrop-blur-xl rounded-[3rem] border shadow-2xl mx-auto max-w-lg animate-in zoom-in duration-500 w-full ${isDarkMode ? 'bg-slate-800/80 border-slate-700' : 'bg-white/70 border-white'}`}>
                                    <div className="w-24 h-24 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-8 shadow-lg shadow-indigo-500/30"><Icon name="PieChart" size={48} className="text-white" /></div>
                                    <h2 className={`text-4xl font-bold mb-4 tracking-tight ${textPrimary}`}>WorkPulse Cloud</h2>
                                    <p className={`mb-8 font-medium ${textSecondary}`}>Team management reimagined.</p>
                                    <button onClick={() => setModal('join')} className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-10 py-4 rounded-full font-bold shadow-lg shadow-indigo-200 hover:shadow-xl hover:-translate-y-1 transition-all text-sm">Get Started</button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* MODALS */}
                    {modal && (
                        <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                            {modal === 'join' && (
                                <div className={`rounded-[2rem] shadow-2xl max-w-sm w-full p-8 animate-in zoom-in-95 duration-200 border backdrop-blur-xl ${isDarkMode ? 'bg-slate-900/95 border-slate-700' : 'bg-white/90 border-white'}`}>
                                    <h2 className={`text-2xl font-bold mb-6 ${textPrimary}`}>Welcome</h2>
                                    <div className="space-y-4">
                                        <input type="text" value={tempName} onChange={e => setTempName(e.target.value)} className={`w-full p-4 border rounded-2xl text-sm font-medium outline-none transition-all ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white focus:border-indigo-500' : 'bg-white/50 border-slate-200 text-slate-900 focus:ring-2 focus:ring-indigo-500'}`} placeholder="Full Name" />
                                        <input type="email" value={tempEmail} onChange={e => setTempEmail(e.target.value)} className={`w-full p-4 border rounded-2xl text-sm font-medium outline-none transition-all ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white focus:border-indigo-500' : 'bg-white/50 border-slate-200 text-slate-900 focus:ring-2 focus:ring-indigo-500'}`} placeholder="Work Email" />
                                        <select value={tempRole} onChange={e => setTempRole(e.target.value)} className={`w-full p-4 border rounded-2xl text-sm font-medium outline-none ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white/50 border-slate-200'}`}>{ROLES.map(r => <option key={r}>{r}</option>)}</select>
                                        <div className="flex gap-3 pt-4"><button onClick={() => setModal(null)} className={`flex-1 py-3 font-bold rounded-2xl transition-colors ${isDarkMode ? 'text-slate-400 hover:bg-slate-800' : 'text-slate-500 hover:bg-slate-100'}`}>Cancel</button><button onClick={handleJoin} className="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-2xl shadow-lg hover:opacity-90">Join</button></div>
                                    </div>
                                </div>
                            )}
                            
                            {modal === 'settings' && (
                                <div className={`rounded-[2rem] shadow-2xl max-w-lg w-full p-6 flex flex-col max-h-[85vh] animate-in zoom-in-95 duration-200 border backdrop-blur-xl ${isDarkMode ? 'bg-slate-900/95 border-slate-700' : 'bg-white/95 border-white'}`}>
                                    <div className="flex justify-between items-center mb-6"><h2 className={`text-xl font-bold ${textPrimary}`}>Manage Team</h2><button onClick={() => setModal(null)} className={`p-2 rounded-full ${isDarkMode?'hover:bg-slate-800 text-slate-400':'hover:bg-slate-100 text-slate-500'}`}><Icon name="X" size={20} /></button></div>
                                    <div className={`p-5 rounded-3xl mb-6 border ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-slate-50 border-slate-100'}`}>
                                        <h3 className={`text-xs font-bold uppercase mb-3 ${isDarkMode?'text-slate-400':'text-slate-500'}`}>Add New Member</h3>
                                        <div className="space-y-3">
                                            <input type="text" value={memberFormName} onChange={e => setMemberFormName(e.target.value)} className={`w-full p-3 border rounded-2xl text-sm outline-none ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200'}`} placeholder="Name" />
                                            <input type="email" value={memberFormEmail} onChange={e => setMemberFormEmail(e.target.value)} className={`w-full p-3 border rounded-2xl text-sm outline-none ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200'}`} placeholder="Email" />
                                            <select value={memberFormRole} onChange={e => setMemberFormRole(e.target.value)} className={`w-full p-3 border rounded-2xl text-sm outline-none ${isDarkMode ? 'bg-slate-900 border-slate-700 text-white' : 'bg-white border-slate-200'}`}>{ROLES.map(r => <option key={r}>{r}</option>)}</select>
                                            <div className="flex gap-2 pt-1">{editingMemberId && <button onClick={handleCancelEdit} className="flex-1 bg-white border border-slate-200 text-slate-600 py-2.5 rounded-2xl font-bold text-sm">Cancel</button>}<button onClick={handleSaveMember} className={`flex-1 text-white py-2.5 rounded-2xl font-bold text-sm shadow-md transition-transform active:scale-95 ${editingMemberId ? 'bg-orange-500' : 'bg-indigo-600'}`}>{editingMemberId ? 'Save Changes' : 'Add User'}</button></div>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">{team.map(m => <div key={m.id} className={`flex justify-between items-center p-3 border rounded-2xl ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}><div><div className={`font-bold text-sm ${textPrimary}`}>{m.name}</div><div className={`text-xs ${textSecondary}`}>{m.role}  {m.email}</div></div><div className="flex gap-1"><button onClick={() => handleEditMember(m)} className="p-2 text-slate-400 hover:text-indigo-600"><Icon name="Pencil" size={16}/></button><button onClick={() => handleDeleteMember(m.id)} className="p-2 text-slate-400 hover:text-red-500"><Icon name="Trash2" size={16} /></button></div></div>)}</div>
                                </div>
                            )}

                            {modal === 'task' && (
                                <div className={`rounded-[2rem] shadow-2xl max-w-md w-full p-6 animate-in zoom-in-95 duration-200 border backdrop-blur-xl ${isDarkMode ? 'bg-slate-900/95 border-slate-700' : 'bg-white/95 border-white'}`}>
                                    <h2 className={`text-xl font-bold mb-6 ${textPrimary}`}>Create New Task</h2>
                                    <div className="space-y-4">
                                        <input type="text" value={newTaskTitle} onChange={e => setNewTaskTitle(e.target.value)} className={`w-full p-4 border rounded-2xl text-lg font-medium outline-none ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white placeholder-slate-500' : 'bg-slate-50 border-slate-200 placeholder-slate-400'}`} placeholder="What needs doing?" autoFocus />
                                        <textarea value={newTaskDesc} onChange={e => setNewTaskDesc(e.target.value)} className={`w-full p-4 border rounded-2xl text-sm font-medium outline-none resize-none h-24 ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white placeholder-slate-500' : 'bg-slate-50 border-slate-200 placeholder-slate-400'}`} placeholder="Add description..."></textarea>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className={`text-xs font-bold uppercase ml-1 mb-1 block ${textSecondary}`}>Priority</label><select value={newTaskPriority} onChange={e => setNewTaskPriority(e.target.value)} className={`w-full p-3 border rounded-2xl text-sm outline-none ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200'}`}>{Object.keys(PRIORITIES).map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                                            <div><label className={`text-xs font-bold uppercase ml-1 mb-1 block ${textSecondary}`}>Due Date</label><input type="date" value={newTaskDueDate} onChange={e => setNewTaskDueDate(e.target.value)} className={`w-full p-3 border rounded-2xl text-sm outline-none font-mono ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200'}`} /></div>
                                        </div>
                                        <div className="space-y-2"><label className={`text-xs font-bold uppercase ml-1 ${textSecondary}`}>Assignees</label><div className={`flex flex-wrap gap-2 p-3 border rounded-3xl max-h-32 overflow-y-auto ${isDarkMode ? 'border-slate-700 bg-slate-800/50' : 'border-slate-100'}`}><button onClick={() => { if(newTaskAssignees.includes('Everyone')) setNewTaskAssignees(newTaskAssignees.filter(n=>n!=='Everyone')); else setNewTaskAssignees([...newTaskAssignees,'Everyone']); }} className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-all ${newTaskAssignees.includes('Everyone')?'bg-indigo-600 text-white border-indigo-600 shadow-md':(isDarkMode?'bg-slate-800 border-slate-600 text-slate-300':'bg-white text-slate-500 border-slate-200')}`}>Everyone</button>{team.map((m,i)=><button key={i} onClick={() => { if(newTaskAssignees.includes(m.name)) setNewTaskAssignees(newTaskAssignees.filter(n=>n!==m.name)); else setNewTaskAssignees([...newTaskAssignees,m.name]); }} className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-all ${newTaskAssignees.includes(m.name)?'bg-indigo-600 text-white border-indigo-600 shadow-md':(isDarkMode?'bg-slate-800 border-slate-600 text-slate-300':'bg-white text-slate-500 border-slate-200')}`}>{m.name}</button>)}</div></div>
                                        <div className="grid grid-cols-2 gap-4"><div><label className={`text-xs font-bold uppercase ml-1 mb-1 block ${textSecondary}`}>Dept</label><select value={newTaskDept} onChange={e => setNewTaskDept(e.target.value)} className={`w-full p-3 border rounded-2xl text-sm outline-none ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200'}`}>{DEPARTMENTS.map(d => <option key={d}>{d}</option>)}</select></div><div className={`flex items-center gap-3 p-3 border rounded-2xl cursor-pointer transition-colors ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:bg-slate-700' : 'bg-indigo-50/50 border-indigo-100 hover:bg-indigo-50'}`} onClick={() => setNewTaskRequireReview(!newTaskRequireReview)}><div className={`w-5 h-5 rounded-full flex items-center justify-center border ${newTaskRequireReview ? 'bg-indigo-600 border-indigo-600' : 'border-slate-400'}`}>{newTaskRequireReview && <Icon name="Check" size={12} className="text-white" />}</div><span className={`text-xs font-semibold ${textPrimary}`}>Review Needed</span></div></div>
                                        <label className="flex items-center justify-center gap-2 w-full h-14 border border-dashed border-slate-300 rounded-2xl cursor-pointer hover:bg-slate-50 hover:border-slate-400 transition-all text-slate-500 hover:text-slate-700"><Icon name="Camera" size={18} /><span className="text-sm font-medium">{newTaskPhoto ? "Photo Attached" : "Attach Photo"}</span><input type="file" accept="image/*" className="hidden" onChange={handlePhotoUpload} /></label>
                                        
                                        {/* --- LIVE G-CAL BUTTON (Bottom Location) --- */}
                                        <a 
                                            href={(!newTaskTitle || !newTaskDueDate) ? '#' : `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(newTaskTitle)}&dates=${formatCalDate(newTaskDueDate)}/${getNextDay(newTaskDueDate)}&details=${encodeURIComponent("WorkPulse Task - Tip: Set Visibility to 'Private' to hide details from others.")}&add=${getAssigneeEmails({assignees: newTaskAssignees})}`} 
                                            target="_blank" 
                                            className={`w-full py-3 mb-2 rounded-2xl border flex items-center justify-center gap-2 font-bold text-sm transition-all ${(!newTaskTitle || !newTaskDueDate) ? (isDarkMode?'bg-slate-800 text-slate-600 border-slate-700':'bg-slate-50 text-slate-300 border-slate-100') : (isDarkMode ? 'bg-slate-800 text-indigo-400 border-slate-700 hover:bg-slate-700' : 'bg-white text-indigo-600 border-indigo-200 hover:bg-indigo-50')}`}
                                            onClick={(e) => { if(!newTaskTitle || !newTaskDueDate) e.preventDefault(); }}
                                            title="Enter Title & Date to enable"
                                        >
                                            <Icon name="CalendarPlus" size={18} /> Schedule on Google Calendar (Optional)
                                        </a>

                                        <div className="flex gap-3 pt-2"><button onClick={() => setModal(null)} className={`flex-1 py-3.5 font-bold rounded-2xl transition-colors ${isDarkMode ? 'text-slate-400 hover:bg-slate-800' : 'text-slate-500 hover:bg-slate-100'}`}>Cancel</button><button onClick={handleCreateTask} className="flex-1 py-3.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-2xl shadow-lg hover:opacity-90">Create Task</button></div>
                                    </div>
                                </div>
                            )}

                            {/* DETAIL MODAL (FULL) */}
                            {modal === 'detail' && selectedTask && (
                                <div className={`fixed inset-0 bg-black/40 z-50 flex justify-end backdrop-blur-sm`}>
                                    <div className={`w-full md:w-[600px] h-full shadow-2xl flex flex-col border-l animate-slide-in-right ${isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100'}`}>
                                        <div className={`p-6 border-b backdrop-blur-md sticky top-0 z-10 flex justify-between items-start ${isDarkMode ? 'bg-slate-900/80 border-slate-700' : 'bg-white/80 border-slate-100'}`}>
                                            <div className="flex-1 pr-12">
                                                {isEditingTitle ? <div className="flex gap-2"><input autoFocus type="text" className={`text-xl font-bold border rounded-lg px-2 py-1 w-full outline-none ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-indigo-200 text-slate-800'}`} value={editTitleValue} onChange={e=>setEditTitleValue(e.target.value)} onBlur={()=>{if(editTitleValue.trim()){updateTask(selectedTask.id,{title:editTitleValue});setIsEditingTitle(false);}}} /><button className="text-green-600 bg-green-50 p-1 rounded" onMouseDown={()=>{if(editTitleValue.trim()){updateTask(selectedTask.id,{title:editTitleValue});setIsEditingTitle(false);}}}><Icon name="Check" size={20}/></button></div> : <h2 onClick={()=>{setEditTitleValue(selectedTask.title);setIsEditingTitle(true);}} className={`text-xl font-bold mb-2 break-words hover:text-indigo-500 cursor-pointer flex gap-2 ${textPrimary}`}>{selectedTask.title}<Icon name="Pencil" size={14} className="mt-1.5 opacity-50"/></h2>}
                                                <div className="flex flex-wrap gap-2 items-center"><StatusPill status={selectedTask.status} onClick={(e)=>cycleStatus(selectedTask,e)} isDarkMode={isDarkMode} /><span className={`text-[10px] font-bold px-2 py-1 rounded-full border ${isDarkMode ? PRIORITIES[selectedTask.priority].dark : PRIORITIES[selectedTask.priority].light}`}>{selectedTask.priority || 'Medium'}</span><button onClick={handleToggleStuck} className={`p-2 rounded-full border ${!!selectedTask.stuckReason ? 'bg-red-100 text-red-600 border-red-200' : (isDarkMode?'text-slate-500 border-slate-700 hover:text-red-400':'text-slate-400 border-slate-200 hover:text-red-500')}`} title="Report Issue / Stuck"><Icon name="AlertTriangle" size={16}/></button></div>
                                            </div>
                                            <button onClick={() => setModal(null)} className={`absolute top-6 right-6 p-2 rounded-full ${isDarkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-slate-100 text-slate-400'}`}><Icon name="X" size={24} /></button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                                            {selectedTask.photo && <img src={selectedTask.photo} onClick={() => setViewImage(selectedTask.photo)} className="w-full max-h-80 object-contain rounded-2xl border bg-slate-50 cursor-zoom-in" />}
                                            <div className={`p-4 rounded-xl border transition-colors group ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-indigo-50/50 border-indigo-100'}`}>
                                                <h3 className={`text-xs font-bold uppercase mb-2 flex justify-between ${isDarkMode ? 'text-indigo-400' : 'text-indigo-500'}`}><span>Details</span>{!isEditingDesc && <Icon name="Pencil" size={12} className="opacity-0 group-hover:opacity-100 cursor-pointer" onClick={()=>{setEditDescValue(selectedTask.description); setIsEditingDesc(true);}}/>}</h3>
                                                {isEditingDesc ? (<div><textarea className={`w-full p-3 rounded-lg text-sm border outline-none min-h-[100px] ${isDarkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-indigo-200 text-slate-800'}`} value={editDescValue} onChange={e=>setEditDescValue(e.target.value)}></textarea><button onClick={()=>{updateTask(selectedTask.id, {description: editDescValue}); setIsEditingDesc(false);}} className="bg-indigo-600 text-white px-3 py-1 rounded mt-2 text-xs font-bold">Save</button></div>) : (<p className={`text-sm whitespace-pre-wrap ${textSecondary}`} onClick={()=>{setEditDescValue(selectedTask.description); setIsEditingDesc(true);}}>{selectedTask.description || 'No description.'}</p>)}
                                            </div>
                                            <div>
                                                <div className="flex justify-between mb-3"><h3 className={`text-xs font-bold uppercase ${textSecondary}`}>Assignees</h3><button onClick={() => setIsManagingAssignees(!isManagingAssignees)} className="text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded font-bold">Edit</button></div>
                                                <div className="flex flex-wrap gap-2">{getSafeAssignees(selectedTask).map((a,i)=><span key={i} className={`text-sm px-3 py-1.5 rounded-full font-medium border flex items-center gap-2 ${isDarkMode?'bg-slate-800 border-slate-700 text-slate-300':'bg-slate-100 border-slate-200 text-slate-700'}`}>{a} {isManagingAssignees && <button onClick={()=>handleAddAssignee(a)} className="text-red-500"><Icon name="X" size={12}/></button>}</span>)}</div>
                                                {isManagingAssignees && <div className="mt-3 p-3 rounded-xl border border-dashed"><div className="flex flex-wrap gap-2">{team.map(m => <button key={m.id} onClick={()=>handleAddAssignee(m.name)} className="px-2 py-1 rounded text-xs border">{m.name}</button>)}</div></div>}
                                            </div>
                                            {selectedTask.dueDate && <div className={`border p-4 rounded-xl flex justify-between items-center ${isDarkMode?'border-slate-700 bg-slate-800':'border-slate-100 bg-slate-50'}`}><div><span className={`text-xs font-bold uppercase block mb-1 ${textSecondary}`}>Due Date</span><div className={`flex items-center gap-2 font-semibold font-mono ${textPrimary}`}><Icon name="Calendar" size={16}/> {formatDate(selectedTask.dueDate)}</div></div><a href={`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(selectedTask.title)}&dates=${formatCalDate(selectedTask.dueDate)}/${getNextDay(selectedTask.dueDate)}&details=${encodeURIComponent("WorkPulse Task - Tip: Set Visibility to 'Private' to hide details from others.")}&add=${getAssigneeEmails(selectedTask)}`} target="_blank" className={`px-4 py-2 border rounded-lg font-bold text-xs flex items-center gap-2 ${isDarkMode?'bg-slate-700 text-indigo-300 border-slate-600':'bg-white text-indigo-600 border-slate-200'}`}><Icon name="CalendarPlus" size={16} /> Add to G-Cal</a></div>}
                                            <div><h3 className={`text-xs font-bold uppercase mb-3 ${textSecondary}`}>Subitems</h3><div className="space-y-2 mb-3">{(selectedTask.subtasks||[]).map(s=><div key={s.id} className={`p-3 rounded-xl border flex items-center gap-3 ${isDarkMode?'bg-slate-800 border-slate-700':'bg-slate-50 border-slate-100'}`}><div onClick={() => handleSubtaskToggle(s)} className={`w-5 h-5 rounded-full border flex items-center justify-center cursor-pointer ${s.completed?'bg-green-500 border-green-500':'border-slate-400'}`}>{s.completed&&<Icon name="Check" size={12} className="text-white"/>}</div><span className={`text-sm flex-1 ${s.completed?'line-through opacity-50':''} ${textPrimary}`}>{s.text}</span>{s.image && <img src={s.image} className="w-8 h-8 rounded object-cover"/>}</div>)}</div><div className="flex gap-2"><input type="text" value={subtaskInput} onChange={e=>setSubtaskInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&subtaskInput&&(()=>{const ns=[...(selectedTask.subtasks||[]),{id:Date.now().toString(),text:subtaskInput,completed:false}];updateTask(selectedTask.id,{subtasks:ns});setSubtaskInput('');})()} placeholder="Add item..." className={`flex-1 border px-4 py-2.5 rounded-xl text-sm outline-none ${isDarkMode?'bg-slate-800 border-slate-700 text-white':'bg-white border-slate-200'}`} /><button onClick={()=>{if(subtaskInput){const ns=[...(selectedTask.subtasks||[]),{id:Date.now().toString(),text:subtaskInput,completed:false}];updateTask(selectedTask.id,{subtasks:ns});setSubtaskInput('');}}} className="p-2.5 bg-indigo-600 text-white rounded-xl"><Icon name="Plus" size={18}/></button></div></div>
                                            <div><h3 className={`text-xs font-bold uppercase mb-3 ${textSecondary}`}>Activity</h3><div className="space-y-3">{selectedTask.comments?.map((c,i)=><div key={i} className={`p-3 rounded-xl border text-sm ${isDarkMode?'bg-slate-800 border-slate-700':'bg-slate-50 border-slate-100'}`}><div className="flex items-center gap-2 mb-1"><span className={`font-bold text-xs ${textPrimary}`}>{c.author}</span><span className={`text-[10px] ${textSecondary}`}>{new Date(c.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div><p className={textSecondary}>{c.text}</p></div>)}</div></div>
                                            {(norm(selectedTask.creatorName||'')===norm(profile.name)||profile.role==='Area Manager') && (<div className="pt-4 border-t border-slate-700/20"><button onClick={deleteTask} className="w-full text-red-500 py-3 border border-dashed border-red-200 rounded-xl hover:bg-red-50/10 transition-colors text-sm font-bold flex items-center justify-center gap-2"><Icon name="Trash2" size={16}/> Delete Task</button></div>)}
                                        </div>
                                        <div className={`p-4 border-t sticky bottom-0 z-10 ${isDarkMode?'bg-slate-900 border-slate-700':'bg-white border-slate-100'}`}><div className={`flex gap-2 p-1.5 rounded-2xl border ${isDarkMode?'bg-slate-800 border-slate-700':'bg-slate-50 border-slate-200'}`}><input type="text" value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&chatInput&&(()=>{const c={text:chatInput,author:profile.name,timestamp:Date.now()}; updateTask(selectedTask.id,{comments:[...(selectedTask.comments||[]),c]}); setChatInput('');})()} placeholder="Write an update..." className={`flex-1 bg-transparent px-4 text-sm outline-none placeholder-slate-400 text-current ${isDarkMode ? 'text-white' : 'text-slate-800'}`} /><button onClick={()=>{if(chatInput){const c={text:chatInput,author:profile.name,timestamp:Date.now()}; updateTask(selectedTask.id,{comments:[...(selectedTask.comments||[]),c]}); setChatInput('');}}} className="bg-indigo-600 text-white p-2.5 rounded-xl disabled:opacity-50" disabled={!chatInput}><Icon name="Send" size={16}/></button></div></div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>